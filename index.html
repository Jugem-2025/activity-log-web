<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>活動記録</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f6fa; }
    header { background: #4a90e2; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 20px; }
    header a { color: white; margin-left: 10px; text-decoration: none; font-size: 20px; }
    .container { padding: 10px; }
    .time-block { border: 1px solid #ccc; padding: 5px; margin-bottom: 5px; background: white; }
    .time-block header { cursor: pointer; background: #eee; padding: 5px; font-weight: bold; }
    .time-block .content { display: none; padding: 5px; }
    .compact { background: #f0f0f0; padding: 5px; font-size: 14px; }
    .daily-note { border-top: 2px solid #4a90e2; padding-top: 10px; margin-top: 10px; background: #ffffff; }
    .btn-save { margin-top: 10px; padding: 5px 10px; background: #4a90e2; color: white; border: none; border-radius: 4px; }
    select, input[type="text"], textarea { margin: 4px 0; width: 100%; }
    .disabled { background: #eee; }
    label { margin-right: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>活動記録</h1>
    <div>
      <a href="weekly.html">📅</a>
      <a href="tags.html">⚙️</a>
    </div>
  </header>
  <div class="container">
    <input type="date" id="datePicker">
    <div id="timeBlocks"></div>
    <button class="btn-save" id="saveAll">保存する</button>
    <div class="daily-note">
      <h2>Daily Note</h2>
      <label><input type="checkbox" id="caffeineCheckbox"> カフェイン</label>
      <label><input type="checkbox" id="alcoholCheckbox"> アルコール</label><br>
      <textarea id="dailyFree" placeholder="摂取内容など"></textarea><br>
      <textarea id="dailyMemo" placeholder="その他備考"></textarea>
    </div>
  </div>

  <script>
    let tagList = JSON.parse(localStorage.getItem('tagList')) || ['起床','朝食','移動','講義','睡眠'];
    let currentDate = null;
    let dailyData = {};

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('datePicker').value = new Date().toISOString().slice(0,10);
      document.getElementById('datePicker').addEventListener('change', render);
      document.getElementById('saveAll').addEventListener('click', () => {
        saveAllBlocks();
        foldAll();
        saveDailyNote();
      });
      render();
    });

    function loadData(date) {
      let data = JSON.parse(localStorage.getItem(date));
      if (!data) {
        data = { blocks: {}, dailyNote: { alcohol: false, caffeine: false, free: '', memo: '' } };
        for (let h = 4; h !== 4 || Object.keys(data.blocks).length === 0; h = (h + 1) % 24) {
          let key = String(h).padStart(2, '0');
          data.blocks[key] = { activity: [], mood: null, fatigue: null, free: '', folded: false };
        }
      }
      return data;
    }

    function render() {
      currentDate = document.getElementById('datePicker').value;
      dailyData = loadData(currentDate);
      renderBlocks();
      renderDailyNote();
    }

    function renderBlocks() {
      const container = document.getElementById('timeBlocks');
      container.innerHTML = '';
      Object.entries(dailyData.blocks).forEach(([hour, block]) => {
        const div = document.createElement('div');
        div.className = 'time-block';
        const hdr = document.createElement('header');
        hdr.textContent = hour + ':00';
        hdr.addEventListener('click', () => {
          block.folded = !block.folded;
          updateCompactView(div, hour, block);
          saveBlock(hour);
        });
        const content = document.createElement('div');
        content.className = 'content';
        content.innerHTML = generateBlockInner(hour, block);
        bindBlockEvents(div, hour, block);
        div.append(hdr, content);
        container.append(div);
        updateCompactView(div, hour, block);
      });
    }

    function generateBlockInner(hour, block) {
      let html = '';
      html += tagList.map(tag => {
        const checked = block.activity.includes(tag) ? 'checked' : '';
        return `<label><input type="checkbox" class="act" value="${tag}" ${checked}>${tag}</label>`;
      }).join('');
      const disabled = block.activity.includes('睡眠') ? 'disabled class="disabled"' : '';
      const mood = block.mood != null ? block.mood : '';
      const fat = block.fatigue != null ? block.fatigue : '';
      html += `<select class="mood" ${disabled}><option value="">気分</option>` +
        Array.from({ length: 101 }, (_, i) => `<option value="${i}" ${mood == i ? 'selected' : ''}>${i}</option>`).join('') +
        `</select>`;
      html += `<select class="fatigue" ${disabled}><option value="">疲労</option>` +
        Array.from({ length: 101 }, (_, i) => `<option value="${i}" ${fat == i ? 'selected' : ''}>${i}</option>`).join('') +
        `</select>`;
      html += `<input type="text" class="free" placeholder="メモ" value="${block.free}">`;
      return html;
    }

    function bindBlockEvents(div, hour, block) {
      const cont = div.querySelector('.content');
      cont.querySelectorAll('.act').forEach(chk => {
        chk.addEventListener('change', e => {
          if (e.target.value === '睡眠' && e.target.checked) {
            cont.querySelectorAll('.act').forEach(c => { if (c.value !== '睡眠') c.checked = false; });
            cont.querySelector('.mood').value = '';
            cont.querySelector('.fatigue').value = '';
            cont.querySelector('.mood').disabled = true;
            cont.querySelector('.fatigue').disabled = true;
            block.activity = ['睡眠'];
          } else {
            block.activity = Array.from(cont.querySelectorAll('.act:checked')).map(c => c.value);
            if (!block.activity.includes('睡眠')) {
              cont.querySelector('.mood').disabled = false;
              cont.querySelector('.fatigue').disabled = false;
            }
          }
          saveBlock(hour);
          updateCompactView(div, hour, block);
        });
      });
      cont.querySelector('.mood').addEventListener('change', e => {
        block.mood = e.target.value !== '' ? +e.target.value : null;
        saveBlock(hour);
        updateCompactView(div, hour, block);
      });
      cont.querySelector('.fatigue').addEventListener('change', e => {
        block.fatigue = e.target.value !== '' ? +e.target.value : null;
        saveBlock(hour);
        updateCompactView(div, hour, block);
      });
      cont.querySelector('.free').addEventListener('input', e => {
        block.free = e.target.value;
        saveBlock(hour);
      });
    }

    function updateCompactView(div, hour, block) {
      const cont = div.querySelector('.content');
      const compact = div.querySelector('.compact');
      if (!block.folded && isEntryDefault(block)) {
        cont.style.display = 'block';
        if (compact) compact.remove();
      } else {
        cont.style.display = 'none';
        if (compact) compact.remove();
        const cm = document.createElement('div');
        cm.className = 'compact';
        cm.textContent = `${hour}:00 — ${block.activity.join(',') || '―'} ` +
                         `${block.mood != null ? `気:${block.mood}` : ''} ` +
                         `${block.fatigue != null ? `疲:${block.fatigue}` : ''} ` +
                         `${block.free}`;
        div.append(cm);
      }
    }

    function isEntryDefault(b) {
      return b.activity.length === 0 && b.mood == null && b.fatigue == null && b.free === '';
    }

    function saveBlock(hour) {
      localStorage.setItem(currentDate, JSON.stringify(dailyData));
    }

    function saveAllBlocks() {
      for (let h in dailyData.blocks) {
        dailyData.blocks[h].folded = true;
      }
      saveBlock(null);
    }

    function renderDailyNote() {
      const dn = dailyData.dailyNote;
      document.getElementById('caffeineCheckbox').checked = dn.caffeine;
      document.getElementById('alcoholCheckbox').checked = dn.alcohol;
      document.getElementById('dailyFree').value = dn.free;
      document.getElementById('dailyMemo').value = dn.memo;
      document.getElementById('caffeineCheckbox').addEventListener('change', e => { dn.caffeine = e.target.checked; saveBlock(null); });
      document.getElementById('alcoholCheckbox').addEventListener('change', e => { dn.alcohol = e.target.checked; saveBlock(null); });
      document.getElementById('dailyFree').addEventListener('input', e => { dn.free = e.target.value; saveBlock(null); });
      document.getElementById('dailyMemo').addEventListener('input', e => { dn.memo = e.target.value; saveBlock(null); });
    }

    function saveDailyNote() {
      localStorage.setItem(currentDate, JSON.stringify(dailyData));
    }

    function foldAll() {
      document.querySelectorAll('.time-block').forEach(block => {
        const header = block.querySelector('header');
        header.click(); // toggle to folded
      });
    }
  </script>
</body>
</html>