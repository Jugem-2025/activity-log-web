<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>活動記録</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
    }
    .hour-block {
      border: 1px solid #ccc;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 5px;
    }
    .hour-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .compact-display {
      padding-left: 1em;
      font-size: 0.9em;
      color: #555;
    }
    .hidden {
      display: none;
    }
    label {
      display: inline-block;
      margin-top: 4px;
    }
    select, input[type="text"] {
      width: 100%;
      margin-bottom: 4px;
    }
    .save-btn {
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <h1>活動記録</h1>
  <input type="date" id="recordDate" />
  <div id="recordArea"></div>

  <script>
    const tags = JSON.parse(localStorage.getItem("tags") || '["起床", "(続き)", "シャワー・風呂", "朝食", "昼食", "夕食", "外出", "移動", "個人課題", "講義", "帰宅", "家事", "休憩", "就寝", "薬", "睡眠"]');
    const options = Array.from({length: 21}, (_, i) => i * 5);
    const recordArea = document.getElementById("recordArea");

    function renderForm(dateStr) {
      recordArea.innerHTML = "";
      const saved = JSON.parse(localStorage.getItem(dateStr) || "{}");

      for (let i = 0; i < 24; i++) {
        const hour = (i + 4) % 24;
        const key = hour.toString().padStart(2, "0");
        const entry = saved[key] || { activity: [], mood: 50, fatigue: 50, free: "", folded: false };

        const block = document.createElement("div");
        block.className = "hour-block";
        const header = document.createElement("div");
        header.className = "hour-header";
        const timeLabel = document.createElement("div");
        timeLabel.textContent = `${key}:00〜`;

        const saveBtn = document.createElement("button");
        saveBtn.textContent = "保存する";
        saveBtn.className = "save-btn";

        const container = document.createElement("div");
        container.className = entry.folded ? "hidden" : "";

        const compact = document.createElement("div");
        compact.className = "compact-display";
        compact.innerHTML = `
          やったこと: ${entry.activity.join(", ")}<br>
          気分: ${entry.mood} / 疲労: ${entry.fatigue}<br>
          メモ: ${entry.free}
        `;
        compact.style.display = entry.folded ? "block" : "none";

        const sel = document.createElement("select");
        const defaultOpt = document.createElement("option");
        defaultOpt.textContent = "やったことを選択";
        defaultOpt.value = "";
        sel.appendChild(defaultOpt);
        tags.forEach(tag => {
          const opt = document.createElement("option");
          opt.value = tag;
          opt.textContent = tag;
          sel.appendChild(opt);
        });
        sel.onchange = () => {
          if (sel.value && !entry.activity.includes(sel.value)) {
            entry.activity.push(sel.value);
            renderForm(dateStr); // 再描画
          }
        };

        const moodSel = document.createElement("select");
        options.forEach(val => {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          if (val === entry.mood) opt.selected = true;
          moodSel.appendChild(opt);
        });

        const fatigueSel = document.createElement("select");
        options.forEach(val => {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          if (val === entry.fatigue) opt.selected = true;
          fatigueSel.appendChild(opt);
        });

        const freeInput = document.createElement("input");
        freeInput.type = "text";
        freeInput.placeholder = "自由記入欄";
        freeInput.value = entry.free;

        header.onclick = () => {
          entry.folded = !entry.folded;
          renderForm(dateStr);
        };

        saveBtn.onclick = () => {
          entry.mood = parseInt(moodSel.value);
          entry.fatigue = parseInt(fatigueSel.value);
          entry.free = freeInput.value;
          entry.folded = true;
          saved[key] = entry;
          localStorage.setItem(dateStr, JSON.stringify(saved));
          renderForm(dateStr);
        };

        header.appendChild(timeLabel);
        header.appendChild(saveBtn);
        block.appendChild(header);
        block.appendChild(container);
        block.appendChild(compact);

        container.appendChild(document.createElement("label")).textContent = "やったこと";
        container.appendChild(sel);
        container.appendChild(document.createElement("label")).textContent = "気分";
        container.appendChild(moodSel);
        container.appendChild(document.createElement("label")).textContent = "疲労度";
        container.appendChild(fatigueSel);
        container.appendChild(document.createElement("label")).textContent = "自由記入";
        container.appendChild(freeInput);

        recordArea.appendChild(block);
      }
    }

    const dateInput = document.getElementById("recordDate");
    const today = new Date().toISOString().split("T")[0];
    dateInput.value = today;
    dateInput.onchange = () => renderForm(dateInput.value);
    renderForm(today);
  </script>
</body>
</html>