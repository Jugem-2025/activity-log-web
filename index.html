<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>活動記録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1em; background: #f4f4f4; }
    header { display: flex; justify-content: space-between; align-items: center; }
    h1 { font-size: 1.4em; margin: 0; }
    .icon-group a {
      margin-left: 10px;
      text-decoration: none;
      font-size: 1.4em;
    }
    .entry { background: #fff; padding: 10px; margin: 10px 0; border-radius: 5px; position: relative; }
    label { display: block; font-weight: bold; margin-top: 10px; }
    .checkbox-group label { font-weight: normal; display: inline-block; margin-right: 10px; }
    select, input[type="date"], textarea, input[type="text"] {
      width: 100%; padding: 5px; margin-top: 5px; box-sizing: border-box;
    }
    button { padding: 6px 10px; margin-top: 10px; }
    .save-btn { position: absolute; top: 10px; right: 10px; font-size: 0.8em; }
    .date-label { font-size: 1.4em; margin-top: 10px; display: block; }
  </style>
</head>
<body>
  <header>
    <h1>活動記録</h1>
    <div class="icon-group">
      <a href="weekly.html" title="週間表示">☷</a>
      <a href="tags.html" title="タグ編集">⚙️</a>
    </div>
  </header>

  <label class="date-label" for="dateInput">日付を選択</label>
  <input type="date" id="dateInput">

  <div id="entriesContainer"></div>

  <div class="entry">
    <h3>嗜好品</h3>
    <label><input type="checkbox" id="alcohol"> アルコール</label>
    <label><input type="checkbox" id="caffeine"> カフェイン</label>
    <input type="text" id="preferenceDetails" placeholder="詳細を入力（任意）">
  </div>

  <div class="entry">
    <h3>補足・備考</h3>
    <textarea id="additionalNotes" rows="3" placeholder="自由記入欄"></textarea>
  </div>

  <script>
    const HOURS = Array.from({ length: 24 }, (_, i) => (i + 4) % 24);
    const MOODS = Array.from({ length: 21 }, (_, i) => i * 5);
    const dateInput = document.getElementById('dateInput');
    const container = document.getElementById('entriesContainer');

    dateInput.valueAsDate = new Date();
    dateInput.addEventListener("change", loadEntries);

    function getKey(date, hour) {
      return `log_${date}_h${hour}`;
    }

    function getTagList() {
      const defaultTags = ["起床", "朝食", "講義", "個人課題", "昼食", "休憩", "外出", "夕食", "就寝", "帰宅", "睡眠"];
      const userTags = JSON.parse(localStorage.getItem("activityTags") || "[]");
      const merged = [...new Set([...defaultTags, ...userTags])];
      return merged;
    }

    function createEntryBlock(hour, saved, tags, date) {
      const div = document.createElement("div");
      div.className = "entry";
      const hourLabel = `${hour.toString().padStart(2, '0')}:00〜`;

      const selectedTags = saved?.activity || [];
      const freeText = saved?.freeText || "";

      div.innerHTML = `
        <h3>${hourLabel}</h3>
        <button class="save-btn" onclick="saveSingle(${hour})">保存する</button>

        <div class="checkbox-group" id="activity_${hour}">
          ${tags.map(tag =>
            `<label><input type="checkbox" value="${tag}" ${selectedTags.includes(tag) ? "checked" : ""}>${tag}</label>`
          ).join('')}
        </div>

        <input type="text" id="freeText_${hour}" placeholder="自由記入（やったこと）" value="${freeText}">

        <label>気分（0〜100）</label>
        <select id="mood_${hour}">
          ${MOODS.map(v => `<option value="${v}" ${saved?.mood === v ? "selected" : ""}>${v}</option>`).join('')}
        </select>

        <label>疲労度（0〜100）</label>
        <select id="fatigue_${hour}">
          ${MOODS.map(v => `<option value="${v}" ${saved?.fatigue === v ? "selected" : ""}>${v}</option>`).join('')}
        </select>
      `;
      return div;
    }

    function saveSingle(hour) {
      const date = dateInput.value;
      const checkboxes = document.querySelectorAll(`#activity_${hour} input[type="checkbox"]`);
      const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      const mood = parseInt(document.getElementById(`mood_${hour}`).value);
      const fatigue = parseInt(document.getElementById(`fatigue_${hour}`).value);
      const freeText = document.getElementById(`freeText_${hour}`).value;

      const entry = { hour, activity: selected, mood, fatigue, freeText };
      localStorage.setItem(getKey(date, hour), JSON.stringify(entry));
      alert(`${hour}:00 のデータを保存しました！`);
    }

    function loadEntries() {
      container.innerHTML = '';
      const date = dateInput.value;
      const tags = getTagList();

      for (let hour of HOURS) {
        const saved = JSON.parse(localStorage.getItem(getKey(date, hour))) || {};
        container.appendChild(createEntryBlock(hour, saved, tags, date));
      }

      const note = JSON.parse(localStorage.getItem(`note_${date}`)) || {};
      document.getElementById("alcohol").checked = note.alcohol || false;
      document.getElementById("caffeine").checked = note.caffeine || false;
      document.getElementById("preferenceDetails").value = note.preferenceDetails || "";
      document.getElementById("additionalNotes").value = note.additionalNotes || "";

      // 自動保存
      document.getElementById("preferenceDetails").onchange = saveNote;
      document.getElementById("additionalNotes").onchange = saveNote;
      document.getElementById("alcohol").onchange = saveNote;
      document.getElementById("caffeine").onchange = saveNote;
    }

    function saveNote() {
      const date = dateInput.value;
      const note = {
        alcohol: document.getElementById("alcohol").checked,
        caffeine: document.getElementById("caffeine").checked,
        preferenceDetails: document.getElementById("preferenceDetails").value,
        additionalNotes: document.getElementById("additionalNotes").value
      };
      localStorage.setItem(`note_${date}`, JSON.stringify(note));
    }

    // 初回
    loadEntries();
  </script>
</body>
</html>
