<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>活動記録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: sans-serif;
      margin: 0;
      background-color: #fff;
      color: #000;
    }
    @media (prefers-color-scheme: dark) {
      body { background-color: #111; color: #eee; }
      input, select, textarea, button {
        background-color: #222;
        color: #eee;
        border: 1px solid #555;
      }
    }
    header {
      background-color: #4682b4;
      color: white;
      padding: 1em;
      text-align: center;
      position: relative;
    }
    .top-right {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .icon-button {
      margin-left: 8px;
      font-size: 1.2em;
      background: none;
      border: none;
      cursor: pointer;
      color: white;
    }
    main { padding: 1em; }
    .hour-block {
      border: 1px solid #ccc;
      margin: 1em 0;
      padding: 1em;
      border-radius: 6px;
    }
    .summary-block {
      border: 1px solid #aaa;
      padding: 1em;
      margin: 1em 0;
      border-radius: 6px;
      background-color: #f0f0f0;
    }
    .time-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
    }
    .checkbox-grid label {
      display: flex;
      align-items: center;
      gap: 0.3em;
      white-space: nowrap;
    }
    #recordDate {
      font-size: 1.5em;
      padding: 0.3em;
      margin-top: 0.5em;
    }
    select { width: 100px; }
    .save-button {
      padding: 6px 12px;
      margin-top: 1em;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <header>
    <h1>活動記録</h1>
    <div class="top-right">
      <button class="icon-button" onclick="goToPage('weekly.html')">📅</button>
      <button class="icon-button" onclick="goToPage('tags.html')">⚙️</button>
    </div>
  </header>

  <main>
    <label for="recordDate">日付を選択:</label>
    <input type="date" id="recordDate">
    <div id="recordArea"></div>
    <button onclick="saveAll()" class="save-button">保存する</button>
  </main>

  <script>
    const defaultTags = ["起床", "シャワー・風呂", "朝食", "昼食", "夕食", "外出", "移動", "個人課題", "講義", "帰宅", "家事", "休憩", "就寝", "薬", "睡眠"];
    const hourList = Array.from({ length: 24 }, (_, i) => (i + 4) % 24);

    const dateInput = document.getElementById("recordDate");
    const recordArea = document.getElementById("recordArea");

    function goToPage(page) {
      window.location.href = page;
    }

    function loadTags() {
      const stored = localStorage.getItem("tags");
      const custom = stored ? JSON.parse(stored) : [];
      return Array.from(new Set([...defaultTags, ...custom]));
    }

    function render() {
      const dateStr = dateInput.value;
      recordArea.innerHTML = "";
      const tags = loadTags();

      hourList.forEach(hour => {
        const key = `log_${dateStr}_h${hour}`;
        const data = JSON.parse(localStorage.getItem(key)) || { activity: [], mood: "", fatigue: "", freeText: "" };
        const isSaved = data.activity.length || data.freeText || data.mood || data.fatigue;

        if (isSaved) {
          const sumDiv = document.createElement("div");
          sumDiv.className = "summary-block";
          sumDiv.innerHTML = `
            <div class="time-row">
              <strong>${hour.toString().padStart(2, '0')}:00〜</strong>
              <button onclick="editHour(${hour})">編集する</button>
            </div>
            <div><strong>やったこと:</strong> ${data.activity.join(", ")}</div>
            ${data.freeText ? `<div><strong>メモ:</strong> ${data.freeText}</div>` : ""}
            ${data.activity.includes("睡眠") ? "" : `
              <div><strong>気分:</strong> ${data.mood} / <strong>疲労度:</strong> ${data.fatigue}</div>
            `}
          `;
          recordArea.appendChild(sumDiv);
        } else {
          renderHourInput(hour, data, tags);
        }
      });
    }

    function renderHourInput(hour, data, tags) {
      const div = document.createElement("div");
      div.className = "hour-block";
      const tagCheckboxes = tags.map(tag => `
        <label><input type="checkbox" value="${tag}" ${data.activity.includes(tag) ? "checked" : ""} onchange="onTagChange(this, ${hour})"> ${tag}</label>
      `).join("");

      const moodSelect = Array.from({ length: 21 }, (_, i) => {
        const val = i * 5;
        return `<option value="${val}" ${data.mood == val ? "selected" : ""}>${val}</option>`;
      }).join("");

      const fatigueSelect = Array.from({ length: 21 }, (_, i) => {
        const val = i * 5;
        return `<option value="${val}" ${data.fatigue == val ? "selected" : ""}>${val}</option>`;
      }).join("");

      div.innerHTML = `
        <div class="time-row">
          <strong>${hour.toString().padStart(2, '0')}:00〜</strong>
          <button onclick="saveAll()">保存する</button>
        </div>
        <label>やったこと:</label>
        <div class="checkbox-grid">${tagCheckboxes}</div>
        <label>自由記入:</label>
        <input type="text" id="free_${hour}" value="${data.freeText || ""}">
        <label>気分（0〜100）:</label>
        <select id="mood_${hour}">${moodSelect}</select>
        <label>疲労度（0〜100）:</label>
        <select id="fatigue_${hour}">${fatigueSelect}</select>
      `;
      recordArea.appendChild(div);
    }

    function onTagChange(checkbox, hour) {
      const isSleep = checkbox.value === "睡眠" && checkbox.checked;
      if (isSleep) {
        document.getElementById(`mood_${hour}`).value = "";
        document.getElementById(`fatigue_${hour}`).value = "";
      }
    }

    function saveHour(hour) {
      const dateStr = dateInput.value;
      const key = `log_${dateStr}_h${hour}`;
      const blockIndex = hourList.indexOf(hour);
      const block = document.querySelectorAll(".hour-block")[blockIndex];
      if (!block) return;

      const checkboxes = block.querySelectorAll(`input[type="checkbox"]`);
      const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      const freeText = document.getElementById(`free_${hour}`).value;
      const mood = document.getElementById(`mood_${hour}`).value;
      const fatigue = document.getElementById(`fatigue_${hour}`).value;
      const data = { activity: selected, mood, fatigue, freeText };
      localStorage.setItem(key, JSON.stringify(data));
    }

    function saveAll() {
      hourList.forEach(hour => saveHour(hour));
      render();
    }

    function editHour(hour) {
      const dateStr = dateInput.value;
      const key = `log_${dateStr}_h${hour}`;
      const data = JSON.parse(localStorage.getItem(key)) || {};
      const tags = loadTags();
      renderHourInput(hour, data, tags);
    }

    dateInput.valueAsDate = new Date();
    dateInput.addEventListener("change", render);
    render();
  </script>
</body>
</html>
