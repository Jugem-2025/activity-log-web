<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>活動記録</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f7f9fb; }
    header {
      background: #4a90e2; color: white;
      padding: 10px; display: flex; justify-content: space-between; align-items: center;
    }
    header h1 { margin: 0; font-size: 20px; }
    header a { color: white; font-size: 20px; margin-left: 10px; text-decoration: none; }
    .container { padding: 10px; max-width: 900px; margin: auto; }

    .time-block { border: 1px solid #ccc; background: #fff; margin-bottom: 8px; border-radius: 4px; }
    .time-block header { background: #eee; padding: 5px; font-weight: bold; cursor: pointer; }

    .content { padding: 5px; display: none; font-size: 14px; }
    .compact { padding: 5px; background: #f0f0f0; font-size: 13px; }

    label { margin-right: 8px; display: inline-block; }

    select, input[type="text"] {
      font-size: 13px;
      margin: 4px 4px 6px 0;
      padding: 2px;
    }

    .mood-fatigue-container {
      display: flex; gap: 10px; margin: 4px 0;
    }

    .daily-note {
      background: #fff; padding: 10px;
      margin-top: 20px; border-top: 3px solid #4a90e2; border-radius: 4px;
    }

    .btn-save {
      background: #4a90e2; color: white;
      padding: 8px 16px; border: none;
      border-radius: 4px; cursor: pointer; margin-top: 10px;
    }

    textarea { width: 100%; font-size: 13px; margin-top: 6px; }
    .disabled { background-color: #eee; pointer-events: none; }
  </style>
</head>
<body>
  <header>
    <h1>活動記録</h1>
    <div>
      <a href="weekly.html">📅</a>
      <a href="tags.html">⚙️</a>
    </div>
  </header>

  <div class="container">
    <input type="date" id="datePicker"><br><br>
    <div id="timeBlocks"></div>
    <button class="btn-save" id="saveAll">保存する</button>

    <div class="daily-note">
      <h2>日毎のまとめ</h2>
      <label><input type="checkbox" id="alcoholCheckbox"> アルコール</label>
      <label><input type="checkbox" id="caffeineCheckbox"> カフェイン</label><br>
      <textarea id="dailyFree" placeholder="摂取内容（自由記入）"></textarea>
      <textarea id="dailyMemo" placeholder="その他の備考"></textarea>
    </div>
  </div>

  <script>
    const tagList = [
      "起床", "シャワー・風呂", "朝食", "昼食", "夕食", "外出", "移動",
      "個別課題", "講義", "帰宅", "家事", "休憩", "就寝", "薬", "睡眠"
    ];
    let currentDate = null;
    let dailyData = {};
        document.addEventListener("DOMContentLoaded", () => {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById("datePicker").value = today;
      document.getElementById("datePicker").addEventListener("change", render);
      document.getElementById("saveAll").addEventListener("click", () => {
        for (let h in dailyData.blocks) {
          dailyData.blocks[h].folded = true;
        }
        saveData();
        render();
      });
      render();
    });

    function render() {
      currentDate = document.getElementById("datePicker").value;
      dailyData = loadData(currentDate);
      renderBlocks();
      renderDailyNote();
    }

    function loadData(date) {
      let data = JSON.parse(localStorage.getItem(date));
      if (!data) {
        data = { blocks: {}, dailyNote: { alcohol: false, caffeine: false, free: "", memo: "" } };
        for (let h = 4; h !== 4 || Object.keys(data.blocks).length === 0; h = (h + 1) % 24) {
          const hour = String(h).padStart(2, "0");
          data.blocks[hour] = { activity: [], mood: null, fatigue: null, free: "", folded: false };
        }
      }
      return data;
    }

    function renderBlocks() {
      const container = document.getElementById("timeBlocks");
      container.innerHTML = "";
      let prevMood = 50, prevFatigue = 50;

      for (const [hour, block] of Object.entries(dailyData.blocks)) {
        const div = document.createElement("div");
        div.className = "time-block";

        const header = document.createElement("header");
        header.textContent = `${hour}:00`;
        header.addEventListener("click", () => {
          block.folded = !block.folded;
          saveData();
          render();
        });

        const content = document.createElement("div");
        content.className = "content";

        content.innerHTML += tagList.map(tag =>
          `<label><input type="checkbox" class="act" value="${tag}" ${block.activity.includes(tag) ? "checked" : ""}>${tag}</label>`
        ).join(" ");

        const isSleep = block.activity.includes("睡眠");
        const disabled = isSleep ? "disabled class='disabled'" : "";

        content.innerHTML += `
          <div class="mood-fatigue-container">
            <select class="mood" ${disabled}>
              <option value="">気分</option>
              ${[...Array(21).keys()].map(i => i * 5).map(v =>
                `<option value="${v}" ${block.mood == v ? "selected" : ""}>${v}</option>`).join("")}
            </select>
            <select class="fatigue" ${disabled}>
              <option value="">疲労度</option>
              ${[...Array(21).keys()].map(i => i * 5).map(v =>
                `<option value="${v}" ${block.fatigue == v ? "selected" : ""}>${v}</option>`).join("")}
            </select>
          </div>
          <input type="text" class="free" placeholder="自由記入" value="${block.free}">
        `;

        div.appendChild(header);
        div.appendChild(content);
        container.appendChild(div);

        updateCompactView(div, hour, block);

        // イベント処理
        content.querySelectorAll(".act").forEach(c => c.addEventListener("change", () => {
          const checked = Array.from(content.querySelectorAll(".act:checked")).map(x => x.value);
          if (checked.includes("睡眠")) {
            block.activity = ["睡眠"];
            block.mood = null;
            block.fatigue = null;
          } else {
            block.activity = checked;
          }
          saveData();
          render();
        }));

        content.querySelector(".mood").addEventListener("change", e => {
          block.mood = e.target.value ? +e.target.value : null;
          prevMood = block.mood ?? prevMood;
          saveData();
        });
        content.querySelector(".fatigue").addEventListener("change", e => {
          block.fatigue = e.target.value ? +e.target.value : null;
          prevFatigue = block.fatigue ?? prevFatigue;
          saveData();
        });
        content.querySelector(".free").addEventListener("input", e => {
          block.free = e.target.value;
          saveData();
        });

        // 初期値自動コピー
        if (block.mood == null) block.mood = prevMood;
        if (block.fatigue == null) block.fatigue = prevFatigue;
      }
    }

    function updateCompactView(div, hour, block) {
      const content = div.querySelector(".content");
      const compact = div.querySelector(".compact");
      if (compact) compact.remove();

      if (block.folded || !isEntryDefault(block)) {
        content.style.display = "none";
        const summary = document.createElement("div");
        summary.className = "compact";
        summary.textContent = `${hour}:00 - ${block.activity.join(",") || "―"} 気:${block.mood ?? ""} 疲:${block.fatigue ?? ""} ${block.free}`;
        div.appendChild(summary);
      } else {
        content.style.display = "block";
      }
    }

    function isEntryDefault(b) {
      return b.activity.length === 0 && b.mood == null && b.fatigue == null && b.free === "";
    }

    function saveData() {
      localStorage.setItem(currentDate, JSON.stringify(dailyData));
    }

    function renderDailyNote() {
      const dn = dailyData.dailyNote;
      document.getElementById("alcoholCheckbox").checked = dn.alcohol;
      document.getElementById("caffeineCheckbox").checked = dn.caffeine;
      document.getElementById("dailyFree").value = dn.free;
      document.getElementById("dailyMemo").value = dn.memo;

      document.getElementById("alcoholCheckbox").onchange = e => { dn.alcohol = e.target.checked; saveData(); };
      document.getElementById("caffeineCheckbox").onchange = e => { dn.caffeine = e.target.checked; saveData(); };
      document.getElementById("dailyFree").oninput = e => { dn.free = e.target.value; saveData(); };
      document.getElementById("dailyMemo").oninput = e => { dn.memo = e.target.value; saveData(); };
    }
  </script>
</body>
</html>